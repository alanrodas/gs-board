<dom-module id="gs-stone">
  <template>
    <style>
      .pointer {
        cursor: pointer;
      }

      .unselectable, .gbs_stone {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      ::content div.blue {
        background: #0A37D0;
        border: solid 1px #008;
      }
      ::content div.black {
        background: #040928;
        border: solid 1px #222;
      }
      ::content div.red {
        background: #A60000;
        border: solid 1px #800;
      }
      ::content div.green {
        background: #0B6600;
        border: solid 1px #080;
      }
      ::content div.O {
        background: white;
        opacity: 0;
        border: solid 1px #222;
      }

      .gbs_stone {
        font-weight: bold;
        font-size: 8pt;
        width: 20px;
        height: 20px;
        -webkit-border-radius: 50%;
        -moz-border-radius: 50%;
        border-radius: 50%;
      }

      .stone_amount {
        vertical-align: sub;
      }

      /*# sourceMappingURL=style.css.map */

    </style>

    <template is="dom-if" if="{{amount}}">
      <div class$="gbs_stone {{color}} {{cssClass()}}">
        <span class="stone_amount">{{amount}}</span>
      </div>
    </template>

    <template is="dom-if" if="{{!amount}}">
      <div class$="gbs_stone O {{cssClass()}}"></div>
    </template>

  </template>
  <script>
    var KeyTracker,
      __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

    Polymer({
      is: 'gs-stone',
      properties: {
        color: String,
        amount: {
          type: Number,
          value: 0,
          notify: true,
          observer: '_sanitizeAmount'
        },
        options: Object
      },
      listeners: {
        click: '_leftClick',
        contextmenu: '_rightClick'
      },
      ready: function() {
        this._sanitizeAmount();
        this._keyTracker = new KeyTracker();
        if (this.options == null) {
          throw new Error("The options are required");
        }
      },
      cssClass: function() {
        if (this.options.editable) {
          return "pointer";
        } else {
          return "";
        }
      },
      _sanitizeAmount: function() {
        if (!(typeof this.amount === 'number' && this.amount >= 0)) {
          return this.amount = 0;
        }
      },
      _leftClick: function(event) {
        if (!this.options.editable || this._keyTracker.isPressed("Control")) {
          return;
        }
        this.amount += 1;
        return event.stopPropagation();
      },
      _rightClick: function(event) {
        if (!this.options.editable) {
          return;
        }
        event.preventDefault();
        return this.amount -= 1;
      }
    });

    KeyTracker = (function() {
      function KeyTracker() {
        this._listenTo = __bind(this._listenTo, this);
        this._indexOf = __bind(this._indexOf, this);
        this.isPressed = __bind(this.isPressed, this);
        this._pressedKeys = [];
        this._listenTo("keydown", (function(_this) {
          return function(ev) {
            var key;
            key = ev.key || ev.keyIdentifier;
            if (!_this.isPressed(key)) {
              return _this._pressedKeys.push(key);
            }
          };
        })(this));
        this._listenTo("keyup", (function(_this) {
          return function(ev) {
            var key;
            key = ev.key || ev.keyIdentifier;
            if (_this.isPressed(key)) {
              return _this._pressedKeys.splice(_this._indexOf(key), 1);
            }
          };
        })(this));
      }

      KeyTracker.prototype.isPressed = function(key) {
        return this._indexOf(key) !== -1;
      };

      KeyTracker.prototype._indexOf = function(key) {
        return this._pressedKeys.indexOf(key);
      };

      KeyTracker.prototype._listenTo = function(eventName, handler) {
        return window.addEventListener(eventName, handler, false);
      };

      return KeyTracker;

    })();

  </script>
</dom-module>