<dom-module id="gs-bolita">
  <template>
    <style>
      :host .container {
        margin: 1px;
        width: 18px;
        height: 18px;
        float: left;
      }
      :host .container .ball {
        width: 18px;
        height: 18px;
        display: block;
        border-radius: 9px;
        float: left;
        font-weight: bold;
        background-size: 100% 100%;
        background-position: center center;
        background-repeat: no-repeat;
      }
      :host .container .ball.negro {
        background-image: url("../assets/bolita/black.png");
        background-color: #111;
        color: #FFF;
      }
      :host .container .ball.azul {
        background-image: url("../assets/bolita/blue.png");
        background-color: #11F;
        color: #FFF;
      }
      :host .container .ball.rojo {
        background-image: url("../assets/bolita/red.png");
        background-color: #F11;
        color: #FFF;
      }
      :host .container .ball.verde {
        background-image: url("../assets/bolita/green.png");
        background-color: #014F00;
        color: #FFF;
      }
      :host .container .ball.unknow {
        background-color: #888;
      }
      :host .container .ball * {
        box-sizing: content-box;
      }
      :host .container .ball .amount {
        cursor: default;
        display: flex;
        font-size: 16px;
        line-height: 18px;
        justify-content: center;
        align-items: center;
      }
      :host.two-digits .container .ball .amount {
        font-size: 12px;
        line-height: 18px;
      }

    </style>

    <div class="container">
      <template is="dom-if" if="{{amount}}">
        <div class$="ball {{color}}" title$="{{ballTitle}}">
          <span class="amount">{{amountView}}</span>
        </div>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'gs-bolita',
      properties: {
        color: {
          type: String,
          value: 'unknow'
        },
        amountView: {
          type: String,
          value: '',
          observer: '_amount_view_change'
        },
        amount: {
          type: Number,
          value: 0,
          notify: true,
          observer: '_amount_change'
        },
        cell: {
          type: Object,
          observer: '_update_amount'
        },
        twoDigits: {
          type: Object,
          observer: '_two_digits_change'
        },
        editable: {
          type: Object,
          observer: '_editable_change'
        },
        ballTitle: {
          type: String,
          value: 'NaN:NaN'
        },
        rowIndex: {
          type: Number,
          value: 0,
          observer: '_update_title'
        },
        columnIndex: {
          type: Number,
          value: 0,
          observer: '_update_title'
        },
        observers: ['_update_amount(cell.*)']
      },
      ready: function() {
        this._update_amount();
        return this._addObserverEffect();
      },
      attached: function() {
        this.editable && this._editable_change(true);
        this._update_title();
        return this.process_two_digits();
      },
      _update_amount: function() {
        return this.amount = this.cell[this.color];
      },
      detached: function() {
        return this.editable && this._editable_change(false);
      },
      _editable_change: function(value) {
        if (value) {
          this.listen(this, 'mousedown', '_mousedown');
          return this.listen(this, 'contextmenu', '_prevent_default');
        } else {
          this.unlisten(this, 'mousedown', '_mousedown');
          return this.unlisten(this, 'contextmenu', '_prevent_default');
        }
      },
      _amount_change: function() {
        if (!(typeof this.amount === 'number' && this.amount >= 0)) {
          this.amount = 0;
        }
        this.cell && (this.cell[this.color] = this.amount);
        this.amountView = this.amount > 99 ? '+' : this.amount;
        return this._update_title();
      },
      _two_digits_change: function() {
        if (this.twoDigits) {
          return this.classList.add('two-digits');
        } else {
          return this.classList.remove('two-digits');
        }
      },
      process_two_digits: function() {
        if (this.amount > 9) {
          return this.twoDigits = true;
        }
      },
      _amount_view_change: function() {
        if (this.amount > 9) {
          this.twoDigits = true;
        }
        if (this.amount <= 9) {
          return this.twoDigits = false;
        }
      },
      _update_title: function() {
        return this.ballTitle = '[' + this.rowIndex + ':' + this.columnIndex + '] - ' + this.color + '[' + this.amount + ']';
      },
      _prevent_default: function(evnt) {
        evnt.preventDefault();
        return false;
      },
      _mousedown: function(evnt) {
        var context, mousemove, mouseup;
        if (evnt.which === 3) {
          evnt.preventDefault();
          return this.amount -= 1;
        } else if (evnt.which === 1) {
          context = {
            item: this
          };
          mousemove = (function(_this) {
            return function(evnt) {
              return _this.make_move(context, evnt);
            };
          })(this);
          mouseup = (function(_this) {
            return function(evnt) {
              if (evnt.which !== 1) {
                return;
              }
              _this.finish_move(context, evnt);
              window.removeEventListener("mousemove", mousemove);
              return window.removeEventListener("mouseup", mouseup);
            };
          })(this);
          window.addEventListener("mouseup", mouseup);
          return window.addEventListener("mousemove", mousemove);
        }
      },
      init_move: function(context, evnt) {
        context.initial_mouse_x = evnt.clientX;
        return context.initial_mouse_y = evnt.clientY;
      },
      make_move: function(context, evnt) {
        return context.move = true;
      },
      finish_move: function(context, evnt) {
        if (!context.move) {
          return this.amount += 1;
        }
      }
    });

  </script>
</dom-module>