<link rel="import" href="gs-cell.html">
<link rel="import" href="key-tracker.html">
<link rel="import" href="resize-box.html">
<dom-module id="gs-board">
  <template>
    <style>
      .pointer {
        cursor: pointer;
      }

      .unselectable {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      table.gbs_board {
        border-style: none;
        border: solid black 0px;
        border-spacing: 0;
        border-collapse: collapse;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 9pt;
        display: inline-block;
        vertical-align: top;
      }

      .gbs_board td {
        margin: 0;
        padding: 2px;
        border: solid #888 1px;
        width: 30px;
        height: 30px;
      }

      .gbs_board td.lv {
        /* labels at the side */
        text-align: center;
        vertical-align: middle;
        border-style: none;
        border: solid black 0px;
        background: #ddd;
        width: 15px;
      }

      .gbs_board td.lh {
        /* labels at the top / bottom */
        text-align: center;
        vertical-align: middle;
        border-style: none;
        border: solid black 0px;
        background: #ddd;
        height: 15px;
      }

      .gbs_board td.lx {
        /* corner */
        border-style: none;
        border: solid black 0px;
        background: #ddd;
        width: 15px;
        height: 15px;
      }

      .gbs_board td.top_left {
        -webkit-border-top-left-radius: 10px;
        -moz-border-top-left-radius: 10px;
        border-top-left-radius: 10px;
      }

      .gbs_board td.top_right {
        -webkit-border-top-right-radius: 10px;
        -moz-border-top-right-radius: 10px;
        border-top-right-radius: 10px;
      }

      .gbs_board td.bottom_left {
        -webkit-border-bottom-left-radius: 10px;
        -moz-border-bottom-left-radius: 10px;
        border-bottom-left-radius: 10px;
      }

      .gbs_board td.bottom_right {
        -webkit-border-bottom-right-radius: 10px;
        -moz-border-bottom-right-radius: 10px;
        border-bottom-right-radius: 10px;
      }

      /*# sourceMappingURL=style.css.map */

    </style>

    <key-tracker id="keyTracker"></key-tracker>

    <table class="gbs_board">
      <tbody>
        <tr>
          <td class="lx top_left"></td>
          <template is="dom-repeat" items="{{columnIndexes}}" as="columnIndex">
            <td class="lh">{{columnIndex}}</td>
          </template>
          <td class="lx top_right"></td>
        </tr>
        <template is="dom-repeat" items="{{table}}" as="row" index-as="rowIndex">
          <tr>
            <td class="lv">{{getRowNumber(rowIndex)}}</td>
            <template is="dom-repeat" items="{{row}}" as="cell" index-as="cellIndex">
              <td>
                <gs-cell cell-index="{{cellIndex}}" row-index="{{rowIndex}}" cell="{{cell}}" table="{{table}}" header="{{header}}" options="{{options}}"></gs-cell>
              </td>
            </template>
            <td class="lv">{{getRowNumber(rowIndex)}}</td>
          </tr>
        </template>
        <tr>
          <td class="lx bottom_left"></td>
          <template is="dom-repeat" items="{{columnIndexes}}" as="columnIndex">
            <td class="lh">{{columnIndex}}</td>
          </template>
          <td class="lx bottom_right">
            <template is="dom-if" if="{{isEditable}}">
              <resize-box></resize-box>
            </template>
          </td>
        </tr>
      </tbody>
    </table>

  </template>
  <script>
    Polymer({
      is: 'gs-board',
      properties: {
        table: Array,
        size: {
          type: Object,
          value: {
            x: 2,
            y: 2
          },
          observer: "_updateColumnIndexes"
        },
        header: {
          type: Object,
          value: {
            x: 0,
            y: 0
          }
        },
        options: {
          type: Object,
          observer: "_updateIsEditable"
        }
      },
      listeners: {
        resize: "_onResize"
      },
      ready: function() {
        this._initializeTable();
        return this._initializeOptions();
      },
      getRowNumber: function(rowIndex) {
        return this.table.length - 1 - rowIndex;
      },
      columnIndexes: function(table) {
        var _i, _ref, _results;
        return (function() {
          _results = [];
          for (var _i = 0, _ref = this.size.x; 0 <= _ref ? _i < _ref : _i > _ref; 0 <= _ref ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this);
      },
      isCtrlPressed: function() {
        return this.$.keyTracker.isPressed("Control");
      },
      _onResize: function(_arg) {
        var delta;
        delta = _arg.detail;
        this.size.x = this.size.x + delta.deltaX;
        this.size.y = this.size.y + delta.deltaY;
        return this._fillTable();
      },
      _initializeTable: function() {
        var _ref;
        if (this.table != null) {
          return this.size = {
            x: ((_ref = this.table[0]) != null ? _ref.length : void 0) || 0,
            y: this.table.length || 0
          };
        } else {
          this.table = [];
          return this._fillTable();
        }
      },
      _fillTable: function() {
        var i, j, limit, _base, _base1, _i, _j, _ref, _ref1;
        limit = function(array, limit) {
          return array.slice(0, limit);
        };
        for (i = _i = 0, _ref = this.size.y; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
          for (j = _j = 0, _ref1 = this.size.x; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; j = 0 <= _ref1 ? ++_j : --_j) {
            if ((_base = this.table)[i] == null) {
              _base[i] = [];
            }
            this.table[i] = limit(this.table[i], this.size.x);
            if ((_base1 = this.table[i])[j] == null) {
              _base1[j] = {};
            }
          }
        }
        return this.table = limit(this.table, this.size.y);
      },
      _initializeOptions: function() {
        var _base;
        if (this.options == null) {
          this.options = {};
        }
        return (_base = this.options).editable != null ? _base.editable : _base.editable = false;
      },
      _updateColumnIndexes: function() {
        var _i, _ref, _results;
        return this.columnIndexes = (function() {
          _results = [];
          for (var _i = 0, _ref = this.size.x; 0 <= _ref ? _i < _ref : _i > _ref; 0 <= _ref ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this);
      },
      _updateIsEditable: function() {
        return this.isEditable = this.options.editable;
      }
    });

  </script>
</dom-module>